name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Build Docker image
        run: docker build -t my-image:$GITHUB_SHA .

      - name: Push Docker image to GAR
        run: |
          docker tag my-image:$GITHUB_SHA gcr.io/my-project/my-image:$GITHUB_SHA
          docker push gcr.io/my-project/my-image:$GITHUB_SHA

  update-helm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@main
        with:
          version: 'latest'
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get latest tag
        id: latest-tag
        run: |
          TAGS=$(gcloud container images list-tags gcr.io/my-project/my-image --format="get(tags)" | tail -n +2 | tr ',' '\n' | sort -nr | head -1)
          echo "LATEST_TAG=${TAGS}" >> $GITHUB_ENV

      - name: Update values.yaml
        run: |
          sed -i 's/^  tag:.*/  tag: '${{ env.LATEST_TAG }}'/' helm-chart/values.yaml

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update values.yaml" -a
          git push

